---
title: event loop 事件循环
date: 2018-06-20 20:53:41
tags: javascript
categories: javascript
---
事件循环 堆、栈、队列
	堆：程序运行时申请的动态内存，在JS运行时存放对象。（一堆一堆的对象）
	
	栈和队列遵循着不同的原则，栈是先进后出，因为有个名称叫压栈，你先来的我
	要把你压下去，后面来的把前面的压下下面，有种长江后浪推前浪，前浪被压在沙滩上。
	
	栈：听的最多的就是执行栈（execution context stack）。程序执行是需要内存存放数据的，对于栈来说，是使用栈内存来存放数据，数据类型有基本数据类型和引用数据类型的地址。除放数据的栈内存，还有一个就是执行主线程的执行栈。
	
	队列：JS除了主线程的执行栈，还存在一个‘任务队列’，那这个任务队列的干什么用的，任务队列，从名称中可以看出是存放任务的，那存放任务的顺序有大概有两个思路，一个是先来的任务我给往后安排执行，另一个思路是来先来的任务先执行。JS中采用的是先来的先执行，这和现实中的工作一样，领导先给你安排的任务，你得先执行它，再执行后面领导给你安排的任务。

	那么问题来了，主线程的任务和任务队列的任务的执行顺序是什么？这个执行顺序的规则有个名称，叫事件循环，英文叫Event Loop。打个比方，主线程的任务相当于一个ATM，任务队列相当于排队取钱的人，只有我ATM机上的任务执行完毕后，我才能去执行任务队列中的任务。

\<img src="http://p8rhahhu3.bkt.clouddn.com/201801/1527341518662.png" width="688"/\>

1. 主线程执行时，JS会产生堆和栈（执行栈）
2. 主线程调用的webapis所产生的异步操作（DOM事件，ajax回调，定时器等），这些操作一旦产生结果，就往任务队列中插入，然后等待被执行。
3. 主线程任务执行完后，依次读取任务队列中任务，然后放在执行栈栈执行。
4. 执行队列中的任务时，可能还会产生其他的异步任务，比如，在一个定时器中还有一个定时器，那么就会产生新的循环，只要这个异步定时器产生结果了，就将其放在任务队列中。

#### 宏任务和微任务

任务也有会员制滴，宏任务（macro-task）就是普通会员，微任务（micro-task）就是VIP会员，享有插队特权，这好像是抢手机时的内部购买码啊，有这个东西我就可以插队买到小米手机咯，你一个宏任务即使凌晨5点起来排队，我微任务有特权啊，我就可以大摇大摆的插在你前面。

含有特权的微任务有：原生Promise，MutationObserver，MessageChannel
宏任务有：setTimeout,setInterval,setImmediate,I/O;


[1]:	https://juejin.im/post/5aab2d896fb9a028b86dc2fd

参考掘金文章：[https://juejin.im/post/5aab2d896fb9a028b86dc2fd][1]